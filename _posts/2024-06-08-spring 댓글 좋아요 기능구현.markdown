---
layout: post
title:  "TIL(20240608) [ë‰´ìŠ¤í”¼ë“œ í”„ë¡œì íŠ¸ :ëŒ“ê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥êµ¬í˜„]"
date:  2024-06-08
categories: TIL Spring 
---

---------------------------------------------------------------------


# ğŸ“Œ Spring

## ğŸ’¡ ë‰´ìŠ¤í”¼ë“œ í”„ë¡œì íŠ¸ : ëŒ“ê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥ ì¶”ê°€êµ¬í˜„

ëŒ“ê¸€ë„ ê²Œì‹œë¬¼ ì¢‹ì•„ìš”ì™€ ë™ì¼í•´ì„œ ê²Œì‹œë¬¼ ì¢‹ì•„ìš”ì—ì„œ êµ¬í˜„í–ˆë˜ ì½”ë“œë¥¼
API URL ë“± ì¼ë¶€ ìˆ˜ì •ë§Œ í–ˆë‹¤.


```java
@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class LikesController {

    private final LikesService likesService;

    // ê²Œì‹œë¬¼ ì¢‹ì•„ìš”
    @PostMapping("/post/{postId}/likes")
    public ResponseEntity<String> postLikePost(@PathVariable Long postId, @AuthenticationPrincipal UserDetailsImpl userDetails) {
        likesService.postLikePost(postId, userDetails.getUser());
        return ResponseEntity.ok("ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ë“±ë¡ ì™„ë£Œ");
    }

    // ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ì·¨ì†Œ
    @DeleteMapping("/post/{postId}/unlikes")
    public ResponseEntity<String> postUnlikePost(@PathVariable Long postId, @AuthenticationPrincipal UserDetailsImpl userDetails) {
        likesService.postUnlikePost(postId, userDetails.getUser());
        return ResponseEntity.ok("ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ì·¨ì†Œ ì™„ë£Œ");
    }

    // ëŒ“ê¸€ ì¢‹ì•„ìš”
    @PostMapping("/comment/{commentId}/likes")
    public ResponseEntity<String> likePost(@PathVariable Long commentId, @AuthenticationPrincipal UserDetailsImpl userDetails) {
        likesService.commentLikePost(commentId, userDetails.getUser());
        return ResponseEntity.ok("ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ë“±ë¡ ì™„ë£Œ");
    }

    // ëŒ“ê¸€ ì¢‹ì•„ìš” ì·¨ì†Œ
    @DeleteMapping("/comment/{commentId}/unlikes")
    public ResponseEntity<String> unlikePost(@PathVariable Long commentId, @AuthenticationPrincipal UserDetailsImpl userDetails) {
        likesService.commentUnlikePost(commentId, userDetails.getUser());
        return ResponseEntity.ok("ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ì·¨ì†Œ ì™„ë£Œ");
    }

}


```

```java
@Service
@RequiredArgsConstructor
public class LikesService {

    private final LikesRepository likesRepository;
    private final PostRepository postRepository;
    private final CommentRepository commentRepository;

    // ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ê¸°ëŠ¥
    @Transactional
    public int postLikePost(Long postId, User user) {
        Post post = findPostId(postId);

        // ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì˜ ì‘ì„±ìì¸ì§€ í™•ì¸
        if (post.getUser().getId().equals(user.getId())) {
            throw new IllegalArgumentException("ìì‹ ì˜ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        // ì‚¬ìš©ìê°€ ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸
        if (likesRepository.findByPostIdAndUserId(postId, user.getId()).isPresent()) {
            throw new IllegalArgumentException("ì¤‘ë³µ ì¢‹ì•„ìš”ëŠ” í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            post.setPostLikesCount(post.getPostLikesCount() + 1);
            likesRepository.save(new Likes(post, user, ContentType.POST));
        }
        return post.getPostLikesCount();
    }

    // ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ì·¨ì†Œ ê¸°ëŠ¥
    @Transactional
    public int postUnlikePost(Long postId, User user) {
        Post post = findPostId(postId);

        // ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸
        Likes like = likesRepository.findByPostIdAndUserId(postId, user.getId()).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."));

        post.setPostLikesCount(post.getPostLikesCount() - 1);
        likesRepository.delete(like);
        return post.getPostLikesCount();
    }

    private Post findPostId(Long postId) {
        return postRepository.findById(postId).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œë¬¼ì€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
    }

    // ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ê¸°ëŠ¥
    @Transactional
    public int commentLikePost(Long commentId, User user) {
        Comment comment = findCommentId(commentId);

        // ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì˜ ì‘ì„±ìì¸ì§€ í™•ì¸
        if (comment.getUser().getId().equals(user.getId())) {
            throw new IllegalArgumentException("ìì‹ ì˜ ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        // ì‚¬ìš©ìê°€ ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸
        if (likesRepository.findByCommentIdAndUserId(commentId, user.getId()).isPresent()) {
            throw new IllegalArgumentException("ì¤‘ë³µ ì¢‹ì•„ìš”ëŠ” í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            comment.setCommentLikesCount(comment.getCommentLikesCount() + 1);
            likesRepository.save(new Likes(comment, user, ContentType.COMMENT));
        }
        return comment.getCommentLikesCount();
    }

    // ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ì·¨ì†Œ ê¸°ëŠ¥
    @Transactional
    public int commentUnlikePost(Long commentId, User user) {
        Comment comment = findCommentId(commentId);

        // ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸
        Likes like = likesRepository.findByCommentIdAndUserId(commentId, user.getId()).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."));

        comment.setCommentLikesCount(comment.getCommentLikesCount() - 1);
        likesRepository.delete(like);
        return comment.getCommentLikesCount();
    }

    private Comment findCommentId(Long commentId) {
        return commentRepository.findById(commentId).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ëŒ“ê¸€ì€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
    }

}

```

```java

@Entity
@Getter
@Setter
@Table(name = "likes")
@NoArgsConstructor
public class Likes extends Timestamped {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "like_id")
    private Long id;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;

    @ManyToOne
    @JoinColumn(name = "post_id")
    Post post;

    @ManyToOne
    @JoinColumn(name = "comment_id")
    Comment comment;

    @Column(name = "content_type")
    @Enumerated(EnumType.STRING)
    private ContentType contentType;

    public Likes(Post post, User user, ContentType contentType) {
        this.post = post;
        this.user = user;
        this.contentType = contentType;
    }

    public Likes(Comment comment, User user, ContentType contentType) {
        this.comment = comment;
        this.user = user;
        this.contentType = contentType;
    }

}


```

```java

@Getter
public class CommentResponseDto {
    private Long id;
    private String contents;
    private LocalDateTime createdAt;
    private LocalDateTime modifiedAt;
    private int commentLikesCount;

    public CommentResponseDto(Comment comment) {
        this.id = comment.getId();
        this.contents = comment.getContents();
        this.createdAt = comment.getCreatedAt();
        this.modifiedAt = comment.getModifiedAt();
        this.commentLikesCount = comment.getCommentLikesCount();
    }

}

```

ì¢‹ì•„ìš” ë¶€ë¶„ì—ì„œëŠ” ì‚¬ì‹¤ ë§Œì¡±ìŠ¤ëŸ½ê²Œ êµ¬í˜„ì´ ëœê±° ê°™ì•„ì„œ .. ë¿Œë“¯...(?)ğŸ˜‚
ê²Œì‹œë¬¼ ì¢‹ì•„ìš”ë¥¼ ë³µì‚¬ ë¶™ì—¬ë„£ê¸°.. ë³€ìˆ˜ëª… ìˆ˜ì • ì •ë„ë§Œ í•œ ê²ƒ ê°™ë‹¤!




---------------------------------------------------------------------

# ğŸ“Œ .gitignoreì´ ì ìš©ì´ ì•ˆë˜ëŠ” ê²½ìš°

- gitì˜ ìºì‹œê°€ ì›ì¸ì´ë¼ê³  í•œë‹¤. ê·¸ë˜ì„œ gitì— ìˆëŠ” ìºì‹œíŒŒì¼ì„ ì§€ì›Œì£¼ê³  ë‹¤ì‹œ add .

```
git rm -r --cached .
git add .
git commit -m "remove cached"

```

ì´ë©”ì¼ ì¸ì¦ êµ¬í˜„ì„ í•˜ë©´ì„œ application.propertiesì— SMTPê´€ë ¨ ì•± ë¹„ë°€ë²ˆí˜¸ê°€ ìˆì–´ì„œ ë³´ì•ˆì²˜ë¦¬ë¥¼ í•˜ê¸° ìœ„í•´ì„œ
.gitignoreì„ ì‚¬ìš©í•´ë³´ì•˜ë‹¤. ì²˜ìŒ í…ŒìŠ¤íŠ¸ í–ˆì„ ë•Œ ì ìš©ì´ ë˜ì§€ ì•Šì•„ ìºì‹œíŒŒì¼ì„ ì§€ì›Œì£¼ê³  ë¸Œëœì¹˜ ì‚­ì œ í›„ ë‹¤ì‹œ pushí–ˆë‹¤.
ì ìš© ì™„ë£Œ!ğŸ˜ 





