---
layout: post
title:  "TIL(20240609) [ë‰´ìŠ¤í”¼ë“œ í”„ë¡œì íŠ¸ :ì´ë©”ì¼ ì¸ì¦ ë° íšŒì›ê°€ì… êµ¬í˜„ ìˆ˜ì •]"
date:  2024-06-09
categories: TIL Spring 
---

---------------------------------------------------------------------


# ğŸ“Œ Spring

## ğŸ’¡ ë‰´ìŠ¤í”¼ë“œ í”„ë¡œì íŠ¸ : ì´ë©”ì¼ ì¸ì¦ ë° íšŒì›ê°€ì… êµ¬í˜„ ìˆ˜ì •

ì´ì „ì— êµ¬í˜„í–ˆë˜ ë¶€ë¶„ë“¤ì— ë¬¸ì œê°€ ìˆìŒì„ ê°ì§€í–ˆë‹¤.

ê·¸ë˜ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •ì„ í•´ë³´ì•˜ë‹¤. ì‚¬ì‹¤ DBì— ì´ë©”ì¼ ì¸ì¦ ê´€ë ¨í•´ì„œ emailê³¼ codeë¥¼ ì €ì¥í•˜ê³  ì‹¶ì—ˆì§€ë§Œ ì¼íšŒì„± ê°™ì€ ëŠë‚Œì´ë¼ .. Redisë¡œ êµ¬í˜„í•˜ëŠ” ë°©ë²•ë„ ìˆì—ˆì§€ë§Œ ì•„ì§ ë‚´ê°€ Redisêµ¬í˜„ ë°©ë²•ì— ëŒ€í•´ì„œ ì •í™•í•˜ê²Œ ê°œë…ì„ ì•Œê³  ìˆì§€ ì•Šì•„ Mapì»¬ë ‰ì…˜ìœ¼ë¡œ êµ¬í˜„ì„ í•´ë³´ì•˜ë‹¤.
service ë¶€ë¶„ë§Œ ì¡°ê¸ˆ ìˆ˜ì •ì„ í–ˆë‹¤.


```java

@Service
@RequiredArgsConstructor
public class UserService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final JavaMailSender javaMailSender;
    private static final String senderEmail = "ReviewSpot@gmail.com";
    private static int code;
    private final Map<String, String> verificationCodes = new HashMap<>();
    private final Map<String, Boolean> verificationStatus = new HashMap<>();

    // ì¸ì¦ë²ˆí˜¸ ìƒì„±
    public static String createCode() {
        int code = (int) (Math.random() * (90000)) + 100000;
        return String.valueOf(code);
    }

    // ì´ë©”ì¼ ìƒì„±
    public MimeMessage createMail(String email, String code) throws MessagingException {
        createCode();
        MimeMessage message = javaMailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");

        try {
            helper.setFrom(senderEmail);
            helper.setTo(email);
            helper.setSubject("ReviewSpot [íšŒì›ê°€ì…ì„ ìœ„í•œ ì´ë©”ì¼ ì¸ì¦]");
            String body = "";
            body += "<h3>" + "ì´ë©”ì¼ ì¸ì¦ ë²ˆí˜¸" + "</h3>";
            body += "<h1>" + code + "</h1>";
            body += "<h3>" + "ìœ„ ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." + "</h3>";
            helper.setText(body, true);
        } catch (MessagingException e) {
            e.printStackTrace();
        }
        return message;
    }

    // ì´ë©”ì¼ ì „ì†¡
    public void sendMail(EmailRequestDto requestDto) throws MessagingException {
        String code = createCode();
        // ì¸ì¦ë²ˆí˜¸ ì„ì‹œì €ì¥
        verificationCodes.put(requestDto.getEmail(), code);
        // ê²€ì¦í™•ì¸ ì—¬ë¶€ ì„ì‹œì €ì¥
        verificationStatus.put(requestDto.getEmail(), false);

        MimeMessage message = createMail(requestDto.getEmail(), code);
        javaMailSender.send(message);
    }

    // ì¸ì¦ë²ˆí˜¸ ê²€ì¦
    public void checkCode(VerifyCodeRequestDto requestDto) {
        String email = requestDto.getEmail();
        String inputCode = requestDto.getVerificationCode();
        String checkCode = verificationCodes.get(email);

        if (checkCode != null && checkCode.equals(inputCode)) {
            verificationStatus.put(email, true);
        } else {
            throw new IllegalArgumentException("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ì¸ì¦ë²ˆí˜¸ ì…ë‹ˆë‹¤.");
        }
    }

    // íšŒì›ê°€ì…
    public void signup(SignupRequestDto requestDto) {
        String userId = requestDto.getUserId();
        String password = passwordEncoder.encode(requestDto.getPassword());
        String userName = requestDto.getUserName();
        String email = requestDto.getEmail();

        Optional<User> checkEmail = userRepository.findByEmail(email);
        if (checkEmail.isPresent()) {
            throw new IllegalArgumentException("ì¤‘ë³µëœ Email ì…ë‹ˆë‹¤.");
        }

        boolean verified = verificationStatus.get(email);
        UserStatus userStatus;
        if (verified) {
            userStatus = UserStatus.MEMBER;
        } else {
            userStatus = UserStatus.NOT_AUTH;
        }

        // íšŒì› ì¤‘ë³µ í™•ì¸
        Optional<User> checkUsername = userRepository.findByUserId(userId);
        if (checkUsername.isPresent()) {
            throw new IllegalArgumentException("ì¤‘ë³µëœ ì‚¬ìš©ìê°€ ì¡´ì¬í•©ë‹ˆë‹¤.");
        }

        User user = new User(userId, password, userName, email, userStatus);
        userRepository.save(user);
    }

```

ì´ë©”ì¼ ì¸ì¦ ë¶€ë¶„ì—ì„œ ê°€ì¥ ì•„ì‰¬ì› ë˜ ê±´ Mapì„ ì‚¬ìš©í•œ ê²ƒ. Mapì„ ì‚¬ìš©í•  ê²½ìš° ì„œë²„ê°€ ëŠê¸°ê²Œ ë˜ë©´ ì €ì¥ëœ ë‚´ìš©(ì„ì‹œë©”ëª¨ë¦¬ì— ì €ì¥)ì´ ì‚¬ë¼ì§€ê¸° ë•Œë¬¸ì— ë‹¤ì‹œ ì´ë©”ì¼ ì¸ì¦ì„ í•´ì•¼í•œë‹¤ëŠ” ì‚¬ì‹¤.. í—ˆí—ˆí—ˆ.. ì •ë§ ì´ ë¶€ë¶„ì´ ê°€ì¥ ì•„ì‰½ë‹¤. 

ë¨¸ë¦¬ì— ê°‘ìê¸° ê³¼ë¶€í•˜ê°€ ê±¸ë ¸ëŠ”ì§€ ë„ˆë¬´ ëŒì•„ê°€ì§€ ì•Šì•˜ë‹¤.
ì¢‹ì€ ë°©ë²•ì— ëŒ€í•´ì„œ ê³„ì†í•´ì„œ ê³ ë¯¼í•˜ëŠ”ë°, ê²½í—˜ì´ ë§ì§€ ì•Šì•„ì„œ
ê·¸ëŸ°ê²ƒ ê°™ë‹¤.. ë‹¤ë¥¸ì‚¬ëŒë“¤ì€ ì–´ë–»ê²Œ êµ¬í˜„í•˜ëŠ”ì§€ì— ëŒ€í•´ì„œ ê¾¸ì¤€íˆ êµ¬ê¸€ë§í•˜ì—¬ ê³µë¶€í•´ì•¼ í•  ê²ƒ ê°™ë‹¤. 






