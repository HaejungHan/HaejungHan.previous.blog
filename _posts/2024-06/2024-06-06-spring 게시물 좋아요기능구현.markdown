---
layout: post
title:  "TIL(20240606) [ë‰´ìŠ¤í”¼ë“œí”„ë¡œì íŠ¸:ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ê¸°ëŠ¥êµ¬í˜„]"
date:  2024-06-06
categories: TIL Spring
---

---------------------------------------------------------------------


# ğŸ“Œ Spring 


## ğŸ’¡ ë‰´ìŠ¤í”¼ë“œ í”„ë¡œì íŠ¸ : ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ê¸°ëŠ¥êµ¬í˜„
- ì¢‹ì•„ìš” Entity

```SQL
CREATE TABLE ì¢‹ì•„ìš” (
    ID BIGINT PRIMARY KEY,
    ì‚¬ìš©ì_ID BIGINT 
    ì½˜í…ì¸ _ID BIGINT 
    ì½˜í…ì¸ _ìœ í˜• VARCHAR(255) 
    ìƒì„±ì¼ì TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ìˆ˜ì •ì¼ì TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

// ìœ„ì™€ ê°™ì´ í…Œì´ë¸”ì„ ë§Œë“ ê²ƒì€ ì•„ë‹ˆê³  ì¡°ê±´ ì»¬ëŸ¼ì´ ì €ëŸ¬í•˜ë‹¤ëŠ” ê²ƒ!
```

- ê²Œì‹œë¬¼ ë° ëŒ“ê¸€ ì¢‹ì•„ìš”/ ì¢‹ì•„ìš” ì·¨ì†Œ ê¸°ëŠ¥<br>
    1) ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì´ë‚˜ ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ ë‚¨ê¸°ê±°ë‚˜ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
    2) ë³¸ì¸ì´ ì‘ì„±í•œ ê²Œì‹œë¬¼ê³¼ ëŒ“ê¸€ì— ì¢‹ì•„ìš”ë¥¼ ë‚¨ê¸¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
    3) ê°™ì€ ê²Œì‹œë¬¼ì—ëŠ” ì‚¬ìš©ìë‹¹ í•œ ë²ˆë§Œ ì¢‹ì•„ìš”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>


ìœ„ì˜ ì¡°ê±´ì„ ê°€ì§€ê³  í˜„ì¬ ëŒ“ê¸€ ê¸°ëŠ¥ì€ êµ¬í˜„ì´ ë˜ì§€ì•Šì•„ ê²Œì‹œë¬¼  ë¨¼ì € ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ êµ¬í˜„í•´ë³´ì•˜ë‹¤.

```java
@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class LikesController {

    private final LikesService likesService;

    // ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš”
    @PostMapping("/post/{postId}/likes")
    public ResponseEntity<LikesResponseDto> likePost(@PathVariable Long postId, @AuthenticationPrincipal UserDetailsImpl userDetails) {
        Integer likesCount = likesService.likePost(postId,userDetails.getUser());
        LikesResponseDto responseDto = new LikesResponseDto(postId,likesCount,"ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.");
        return ResponseEntity.status(HttpStatus.OK).body(responseDto);
    }

    // ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ì·¨ì†Œ
    @DeleteMapping("/post/{postId}/unlikes")
    public ResponseEntity<LikesResponseDto> unlikePost(@PathVariable Long postId, @AuthenticationPrincipal UserDetailsImpl userDetails) {
        Integer likesCount = likesService.unlikePost(postId,userDetails.getUser());
        LikesResponseDto responseDto = new LikesResponseDto(postId,likesCount,"ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.");
        return ResponseEntity.status(HttpStatus.OK).body(responseDto);
    }

}

```

PostControllerì—ì„œ êµ¬í˜„í•´ë„ ë˜ì§€ë§Œ ëŒ“ê¸€ë„ ì¢‹ì•„ìš”ë¥¼ êµ¬í˜„í•´ì•¼í•˜ê¸°ì— ì½”ë“œì˜ ìœ ì§€ë³´ìˆ˜ì¸¡ë©´ì´ë‚˜ ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•´ LikesControllerë¥¼ ë§Œë“¤ì—ˆë‹¤. ì¢‹ì•„ìš”ë¥¼ ìš”ì²­í•˜ë©´ ê²Œì‹œíŒIdì™€ ì¢‹ì•„ìš” ìˆ˜ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ë°˜í™˜í˜•íƒœë¥¼ ìœ„ì™€ ê°™ì´ êµ¬ì„±í–ˆë‹¤.


```java
@Service
@RequiredArgsConstructor
public class LikesService {

    private final LikesRepository likesRepository;
    private final PostRepository postRepository;

    // ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ê¸°ëŠ¥
    @Transactional
    public Integer likePost(Long postId, User user) {
        Post post = findPostId(postId);

        // ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì˜ ì‘ì„±ìì¸ì§€ í™•ì¸
        if (post.getUser().getId().equals(user.getId())) {
            throw new IllegalArgumentException("ìì‹ ì˜ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
        // ì‚¬ìš©ìê°€ ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸
        if (likesRepository.findByPostIdAndUserId(postId, user.getId()).isPresent()) {
            throw new IllegalArgumentException("ì¤‘ë³µ ì¢‹ì•„ìš”ëŠ” í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        } else {
            post.setLikesCount(post.getLikesCount() + 1);
            likesRepository.save(new Likes(post, user, ContentType.POST));
        }
        return post.getLikesCount();
    }

    // ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš” ì·¨ì†Œ ê¸°ëŠ¥
    @Transactional
    public Integer unlikePost(Long postId, User user) {
        Post post = findPostId(postId);

        // ì‚¬ìš©ìê°€ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸
        Likes like = likesRepository.findByPostIdAndUserId(postId, user.getId()).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."));

        post.setLikesCount(post.getLikesCount() - 1);
        likesRepository.delete(like);
        return post.getLikesCount();
    }

    private Post findPostId(Long postId) {
        return postRepository.findById(postId).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œë¬¼ì€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
    }

}
```

ê²Œì‹œë¬¼ì˜ ì¢‹ì•„ìš”ë¥¼ êµ¬í˜„í•˜ëŠ”ë° ê¼¬ë°• í•˜ë£¨ê°€ ê±¸ë ¸ë‹¤.. ì˜¤í›„ 1ì‹œë¶€í„° ì‹œì‘í•´ ê±°ì˜ ë°¤ 11ì‹œê°€ ë‹¤ë˜ì–´ì„œ í…ŒìŠ¤íŠ¸ê¹Œì§€ ë§ˆë¬´ë¦¬í•˜ê³  ì½”ë“œ ì ê²€ í›„ pushí–ˆë‹¤. 
<br>

Service ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì´ ê³ ë¯¼í•´ë³´ì•˜ë‹¤.

    1) ìì‹ ì˜ ê²Œì‹œë¬¼ì—ëŠ” ì¢‹ì•„ìš”ë¥¼ í•  ìˆ˜ ì—†ë‹¤
    -> ê²Œì‹œë¬¼ì„ ì‘ì„±í•œ ì‚¬ìš©ì ì•„ì´ë””ì™€ í˜„ì¬ ì‚¬ìš©ì ì•„ì´ë””ê°€ ê°™ë‹¤ë©´ ì¢‹ì•„ìš”ë¥¼ í•  ìˆ˜ì—†ë‹¤.
    2) ê°™ì€ ê²Œì‹œë¬¼ì—ëŠ” í•˜ë‚˜ì˜ ì¢‹ì•„ìš”ë§Œ ê°€ëŠ¥í•˜ë‹¤
    -> likeRepositoryì— í•´ë‹¹ ê²Œì‹œë¬¼ì•„ì´ë””ì—ì„œ í˜„ì¬ ì‚¬ìš©ìê°€  ì¢‹ì•„ìš”ë¥¼ í–ˆëŠ”ì§€ í™•ì¸í•´ì•¼í•œë‹¤. 

ê·¸ë¦¬ê³  Setì»¬ë ‰ì…˜ìœ¼ë¡œ í•œë²ˆ êµ¬í˜„í•´ë³´ê³  ì‹¶ë‹¤ëŠ” ìƒê°ì„ í–ˆë‹¤.
ì¤‘ë³µ ì‚¬ìš©ì´ í—ˆìš©ë˜ì§€ ì•Šìœ¼ë‹ˆ ìì‹ ì˜ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í•  ìˆ˜ ì—†ë‹¤ëŠ” êµ¬í˜„ì´ ì¢€ ë” ì‰¬ìš¸ ê±°ë¼ ìƒê°í–ˆë‹¤.. í•˜ì§€ë§Œ ë‚´ ìƒê°ì€ ë‹¬ëë‹¤.. Setì»¬ë ‰ì…˜ì´ ì•„ì§ê¹Œì§„ ë‚¯ì„¤ì—ˆë‹¤. ì—¬ëŸ¬ê°€ì§€ ê³ ë¯¼ê³¼ í•œì°¸ì˜ ì‹œë„ ëì— countì— ++; --; í•˜ìëŠ” ìƒê°ìœ¼ë¡œ êµ¬í˜„ì„ í•´ë³´ì•˜ê³ , ì‚¬ì‹¤ setterë¥¼ ì•ˆì“°ë ¤ê³  ë…¸ë ¥ì„ í•´ì•¼í•˜ëŠ”ë°.. ë‹¤ë¥¸ ë°©ë²•ì´ ë– ì˜¤ë¥´ì§€ ì•Šì•˜ë‹¤. ê·¸ë¦¬ê³  ì¢‹ì•„ìš” ì·¨ì†Œ ê°™ì€ ê²½ìš°ì—ëŠ”
í•´ë‹¹ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ í•˜ì§€ ì•Šì•˜ëŠ”ë°, ì·¨ì†Œë¥¼ í•˜ëŠ”ê²½ìš°ë„ .. ìˆì„ê¹Œ? í–ˆì§€ë§Œ í”„ë¡ íŠ¸ ìª½ì—ì„œ ì–´ë–»ê²Œ í•˜ëŠëƒì— ë”°ë¼ ë‹¤ë¥´ë‹ˆ ê·¸ëƒ¥ ë„ì „í•œë‹¤ ìƒê°í•˜ê³  ì¢‹ì•„ìš”ë¥¼ í•˜ì§€ ì•Šì•˜ëŠ”ë°, ì·¨ì†Œë¥¼ í•˜ë ¤ê³  í•œë‹¤ë©´ ìœ„ì™€ ê°™ì´ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë„ë¡ í–ˆë‹¤. 

ì´í•˜ Entity, ResponseDto, ë‚˜ì¤‘ì— êµ¬í˜„í•  ëŒ“ê¸€ì„ ìœ„í•´ Enumìœ¼ë¡œ ê²Œì‹œë¬¼/ëŒ“ê¸€ì„ êµ¬ë¶„í•œ ê²ƒê¹Œì§€ì˜ ì•„ë˜ì˜ ì½”ë“œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. 

```java
@Entity
@Getter
@Setter
@Table(name = "likes")
@NoArgsConstructor
public class Likes extends Timestamped {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "like_id")
    private Long id;

    @ManyToOne
    @JoinColumn(name = "user_id")
    private User user;

    @ManyToOne
    @JoinColumn(name = "post_id")
    Post post;

//    @ManyToOne
//    @JoinColumn(name = "comment_id")
//    Comment comment;

    @Column(name = "content_type")
    @Enumerated(EnumType.STRING)
    private ContentType contentType;

    public Likes(Post post, User user, ContentType contentType) {
        this.post = post;
        this.user = user;
        this.contentType = contentType;
    }
}
```

```java
@Setter
@Getter
@NoArgsConstructor
public class LikesResponseDto {
    private Long postId;
    private Integer likesCount;
    private String message;

    public LikesResponseDto(Long postId, Integer likesCount, String message) {
        this.postId = postId;
        this.likesCount = likesCount;
        this.message = message;
    }
}
```

```java
@Getter
@RequiredArgsConstructor
public enum ContentType {
    POST("ê²Œì‹œë¬¼"),
    COMMENT("ëŒ“ê¸€");

    private final String contentType;
}
```

ë¡¬ë¶ì´ ìˆìœ¼ë‹ˆ.. ì°¸ ì¢‹ë‹¤.. ë„ˆë¬´ í¸í•´ìš”. ğŸ˜

ì•„ ê·¸ë¦¬ê³  ê³µí†µ ì˜ˆì™¸ì²˜ë¦¬ ë°˜í™˜ì„ ì–´ì œ êµ¬í˜„í–ˆë˜ profileì— ì ìš©í–ˆëŠ”ë°, ê·¸ ë¶€ë¶„ì€ ë‚´ì¼ ë‹¤ì‹œ ì‘ì„±í•´ë³´ë ¤ê³  í•œë‹¤. ì´ì œ ìì•¼í•  ê²ƒ ê°™ë‹¤. ë‚´ì¼ì„ ìœ„í•´! ğŸ˜Š
