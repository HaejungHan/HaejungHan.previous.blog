---
layout: post
title:  "TIL(20240814) [íŠ¸ëŸ¬ë¸” ìŠˆíŒ…: ì¤‘ë³µëœ ì´ë¯¸ì§€ì´ë¦„ì¼ ê²½ìš° ì´ë¯¸ì§€ ë®ì–´ì“°ê¸° ë¬¸ì œë°œìƒ]"
date:  2024-08-14
categories: TIL íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
---

----------------------------------------------------------------------------

8ì›” 14ì¼ (ìˆ˜) ~ 8ì›” 18ì¼ (ì¼) ê¹Œì§€ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ ê¸°ê°„

ê·¸ëŸ¬ë˜ ì¤‘ íŒ€ì›ë¶„ì´ ì¸ì¦ìš”ì²­ì‹œì— ì œëª© ì—†ìŒ.jpg íŒŒì¼ì„ ì—¬ëŸ¬ì¥ ì—…ë¡œë“œ í–ˆì„ë•Œ S3 ë²„í‚·ì—ëŠ” í•´ë‹¹ íŒŒì¼ì˜ ì´ë¦„ìœ¼ë¡œ ê³„ì† ë®ì–´ì“°ì—¬ì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ëŠ” ê²ƒ ê°™ë‹¤ê³  ì•Œë ¤ì£¼ì…¨ë‹¤.

ê·¸ëŸ¬ë‹ˆê¹Œ ì œëª©ì—†ìŒ.jpg íŒŒì¼ë¡œ 3ê°œ ì˜¬ë ¸ì„ ë•Œ ê° ë‹¤ë¥¸ ì´ë¯¸ì§€ ì´ì§€ë§Œ
ë²„í‚·ì—ëŠ” ì œëª©ì—†ìŒ.jpg íŒŒì¼ì´ í•œ ê°œë§Œ ìˆëŠ” ìƒíƒœê°€ ë˜ì–´ë²„ë¦° ê²ƒì´ë‹¤. 

ìœ„ ë¬¸ì œë¥¼ ë“£ê³  ë– ì˜¬ë ¸ë˜ ê±´ ê³ ìœ í•œ ì‹ë³„ìë¥¼ ë§Œë“¤ ë•Œ ì‚¬ìš©í•˜ëŠ” UUIDì´ë‹¤.

### ğŸ’¡ UUID
- UUIDëŠ” 'Universally Unique Identifier'ì˜ ì•½ìë¡œ 128-bitì˜ ê³ ìœ  ì‹ë³„ìë¡œ, ë‹¤ë¥¸ ê³ ìœ  ID ìƒì„± ë°©ë²•ê³¼ ë‹¤ë¥´ê²Œ UUIDëŠ” ì¤‘ì•™ ì‹œìŠ¤í…œì— ë“±ë¡í•˜ê³  ë°œê¸‰í•˜ëŠ” ê³¼ì •ì´ ì—†ì–´ì„œ ìƒëŒ€ì ìœ¼ë¡œ ë” ë¹ ë¥´ê³  ê°„ë‹¨í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆë‹¤.

- (ë‹¨ì )í•˜ì§€ë§Œ ì™„ì „íˆ ê³ ìœ í•˜ì§€ ì•Šì„ í™•ë¥ ì´ ìˆëŠ”ë°, RFC 4122 ë¬¸ì„œì— ì •ì˜ëœ UUID ë²„ì „ 4 í‘œì¤€ ê·œì•½ì„ ë”°ë¥´ë©´ 1ì¡° ê°œì˜ UUID ì¤‘ì— ì¤‘ë³µì´ ì¼ì–´ë‚  í™•ë¥ ì€ 10ì–µ ë¶„ì˜ 1ì´ë¼ê³  í•©ë‹ˆë‹¤.
- (ì¥ì ) UUIDì˜ ë˜ ë‹¤ë¥¸ ì¥ì ì€ ì‘ì€ í¬ê¸°ì¸ë°, ë‹¤ë¥¸ ê³ ìœ  ì‹ë³„ìì— ë¹„í•´ ì •ë ¬, ì°¨ìˆ˜, í•´ì‹± ë“± ë‹¤ì–‘í•œ ì•Œê³ ë¦¬ì¦˜ì— ì‚¬ìš©í•˜ê¸° ì‰½ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ë³´ê´€í•˜ê¸°ë„ ìš©ì´í•˜ë‹¤ê³  í•©ë‹ˆë‹¤.


## ğŸ”’ S3 ë²„í‚· ì´ë¯¸ì§€ ë®ì–´ì“°ê¸° ë¬¸ì œ
- ë¬¸ì œ: ê³ ìœ í•œ ì´ë¦„ ì—†ì´ ì´ë¯¸ì§€ íŒŒì¼ì˜ ì˜¤ë¦¬ì§€ë„ ì´ë¦„ìœ¼ë¡œ S3ì— íŒŒì¼ì„ ì €ì¥ì´ ë˜ë¯€ë¡œì¨ ë™ì¼í•œ ì´ë¦„ì˜ íŒŒì¼ì„ ë®ì–´ì“°ê²Œ ë˜ ì ì¬ì ì¸ ë°ì´í„° ì†ì‹¤ì´ë‚˜ ì˜ëª»ëœ íŒŒì¼ ê²€ìƒ‰ì´ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ë°œìƒ

- ë¬¸ì œ í•´ê²° í”„ë¡œì„¸ìŠ¤:

1. ë¬¸ì œ ì‹ë³„: ì´ë¦„ì´ ì¤‘ë³µëœ íŒŒì¼ì€ S3ì—ì„œ ì„œë¡œ ë®ì–´ì“°ë¯€ë¡œ ì¶©ëŒì´ ë°œìƒí•˜ê³  ê³ ìœ í•œ íŒŒì¼ ìŠ¤í† ë¦¬ì§€ê°€ ì†ì‹¤ëœë‹¤ëŠ” ì ì„ ì¸ì‹í–ˆìŠµë‹ˆë‹¤. 
2. UUID êµ¬í˜„: ê° íŒŒì¼ ì´ë¦„ì— UUIDë¥¼ ì¶”ê°€í•˜ì—¬ ê³ ìœ ì„±ì„ ë³´ì¥í•˜ê³  ë®ì–´ì“°ê¸°ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤. UUIDëŠ” ê° íŒŒì¼ ì´ë¦„ì„ êµ¬ë³„í•˜ëŠ” ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.
3. ì½”ë“œ ì—…ë°ì´íŠ¸: íŒŒì¼ ì´ë¦„ì— UUIDë¥¼ ì¶”ê°€í•˜ë„ë¡ íŒŒì¼ ì—…ë¡œë“œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  UUIDê°€ ìˆëŠ” íŒŒì¼ì„ ì²˜ë¦¬í•˜ë„ë¡ ì‚­ì œ ë¡œì§ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

- ê²°ë¡ :
UUIDë¥¼ íŒŒì¼ ì´ë¦„ì— í†µí•©í•¨ìœ¼ë¡œì¨ S3ì— ì €ì¥ëœ ê° íŒŒì¼ì€ ê³ ìœ í•˜ê²Œ ì‹ë³„ë˜ì–´ ë®ì–´ì“°ê¸° ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ê° íŒŒì¼ì´ ì¶©ëŒ ì—†ì´ ì˜¬ë°”ë¥´ê²Œ ì €ì¥ë˜ê³  ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

```java
// S3ServiceImpl
@Override
  public String imageUpload(MultipartFile image, String uniqueFileName) {
	if (image.isEmpty()) {
	  throw new GlobalException(ErrorCode.EMPTY_FILE);
	}
	fileSizeExceed(image);
	allowedImageTypes(image);
	try {
	  ObjectMetadata metadata = new ObjectMetadata();
	  metadata.setContentType(image.getContentType());
	  metadata.setContentLength(image.getSize());
	  amazonS3Client.putObject(BUCKET, uniqueFileName, image.getInputStream(), metadata);
	  String imageUrl = amazonS3Client.getResourceUrl(BUCKET, uniqueFileName);
	  return imageUrl;
	} catch (IOException e) {
	  throw new FileUploadFailureException("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
	}
  }

  @Override
  public void deleteVerificationImage(Verification verification) {
	DeleteObjectRequest request = new DeleteObjectRequest(BUCKET, verification.getImageName());
	amazonS3Client.deleteObject(request);
  }
```

```java
// VerificationService
@Transactional
  public VerificationResponseDto requestVerification(Long challengeId, MultipartFile image, VerificationRequestDto requestDto, User user) {
      Challenge challenge = challengeService.findById(challengeId);

      duplicateVerification(challengeId, user);

      String key = "verification/";
      String uniqueFileName = key + UUID.randomUUID() + "_" + image.getOriginalFilename();
      String imageUrl = s3Service.imageUpload(image, uniqueFileName);
      Verification verification = new Verification(requestDto.getTitle(), requestDto.getContent(), uniqueFileName, imageUrl, challenge, user);
      verificationRepository.save(verification);
      return new VerificationResponseDto(verification.getId(), verification.getTitle(), verification.getContent(), imageUrl, verification.getStatus());
  }

  @Transactional
  public void cancelVerification(Long verificationId, User user) {
    Verification verification = findVerificationById(verificationId);
    if(verification.getStatus().equals(Status.APPROVE)) {
      throw new GlobalException(ErrorCode.DO_NOT_CANCEL_VERIFICATION);
    }
    verification.checkUser(user);
    s3Service.deleteVerificationImage(verification);
    verificationRepository.delete(verification);
  }
```

- cancelVerificationí•¨ìˆ˜ì—ì„œ deleteVerificationImageì˜ ë§¤ê°œë³€ìˆ˜ê°€ String keyë„ ìˆì—ˆìœ¼ë‚˜ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  ë•Œ í‚¤ê°’ ê°™ì´ ì €ì¥í•˜ëŠ” ì‹ìœ¼ë¡œ êµ¬í˜„ì„ í•˜ì—¬ ë§¤ê°œë³€ìˆ˜ í•œ ê°œë¥¼ ì¤„ì˜€ìŠµë‹ˆë‹¤(?)<br>
 -> requestVerificationì—ì„œ verificationì„ ìƒì„±í• ë•Œ uniqueFileNameë³€ìˆ˜ì— keyì™€ UUID + imageì˜ ê³ ìœ ì´ë¦„ì„ ë„£ê³  ì €ì¥í•˜ì˜€ê¸°ì— ì‚­ì œí•  ë•Œ keyê°’ì´ í•„ìš”ì—†ì–´ì¡ŒìŠµë‹ˆë‹¤.
 -> requestVerificationì—ì„œ uniqueFileNameì„ ê³ ìœ ê°’ìœ¼ë¡œ ë§Œë“  í›„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ì„ í˜¸ì¶œí•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ì—¬ verificationService ì´ì™¸ì˜ serviceì—ì„œ ì´ë¯¸ì§€ì—…ë¡œë“œ ê¸°ëŠ¥ì´ í•„ìš”í•  ê²½ìš° í•´ë‹¹ ë¶€ë¶„ì„ ê³µí†µ ê¸°ëŠ¥ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. String imageUrl = s3Service.imageUpload(image, uniqueFileName);


