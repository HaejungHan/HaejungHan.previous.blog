---
layout: post
title:  "TIL(20240810) [ì´ë¯¸ì§€ì—…ë¡œë“œ ê´€ë ¨ ì½”ë“œ ë¦¬íŒ©í† ë§]"
date:  2024-08-10
categories: TIL refactor
---

----------------------------------------------------------------------------


ì±Œë¦°ì§€ ë“±ë¡ì‹œ ê·¸ë¦¬ê³  ì¸ì¦ìš”ì²­ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ì´ ìˆëŠ”ë° ê°ê° í•˜ë‚˜ì˜ í•¨ìˆ˜ ì•ˆì— ëª¨ë“  ë¡œì§ì´ ì²˜ë¦¬ë˜ì–´ìˆì–´ì„œ
ì½”ë“œì˜ ë°˜ë³µê³¼ ê°€ë…ì„±ì´ ë–¨ì–´ì§„ë‹¤ëŠ” ëŠë‚Œì„ ë°›ì•˜ë‹¤.

ê·¸ë˜ì„œ ì£¼ë§ë™ì•ˆ ë‹¤ë¥¸ë¶€ë¶„ë„ ë§ˆì°¬ê°€ì§€ê² ì§€ë§Œ ì½”ë“œ ë¦¬íŒ©í† ë§ì„ í•˜ê¸°ë¡œ ê³„íší–ˆë‹¤.

```java
// AdminService
public AdminChallengeCreateResponseDto createChallenge(MultipartFile image, AdminChallengeCreateRequestDto reqDto, User loginUser) {
        if (!loginUser.getUserRole().equals(UserRole.ADMIN)) {
            throw new GlobalException(ErrorCode.USER_ACCESS_DENIED);
        }
        try {
            ObjectMetadata metadata = new ObjectMetadata();
            metadata.setContentType(image.getContentType());
            metadata.setContentLength(image.getSize());
            amazonS3Client.putObject(BUCKET, "challenge/" + image.getOriginalFilename(), image.getInputStream(), metadata);

            String imageUrl = amazonS3Client.getResourceUrl(BUCKET, "challenge/" + image.getOriginalFilename());
            Challenge challenge = Challenge.builder()
                .title(reqDto.getTitle())
                .content(reqDto.getContent())
                .image(image.getOriginalFilename())
                .imageUrl(imageUrl)
                .category(Category.valueOf(reqDto.getCategory()))
                .conditionStatus(ConditionStatus.valueOf(reqDto.getConditionStatus()))
                .startTime(reqDto.getStartTime())
                .endTime(reqDto.getEndTime())
                .limitedUsers(reqDto.getLimitedUsers())
                .build();
            Challenge savedChallenge = challengeRepository.save(challenge);
            return new AdminChallengeCreateResponseDto(savedChallenge);
        } catch (IOException e) {
            throw new FileUploadFailureException("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
        }
    }
```
```java
// VerificationService
@Transactional
  public VerificationResponseDto requestVerification(Long challengeId, MultipartFile image, VerificationRequestDto requestDto, User user) {
    try {
      if(image.isEmpty()) {
        throw new GlobalException(ErrorCode.EMPTY_FILE);
      }
      ObjectMetadata metadata= new ObjectMetadata();
      metadata.setContentType(image.getContentType());
      metadata.setContentLength(image.getSize());
      amazonS3Client.putObject(BUCKET, "verification/" + image.getOriginalFilename(), image.getInputStream(), metadata);

      Challenge challenge = challengeService.findById(challengeId);

      LocalDateTime currentDateTime = LocalDateTime.now();
      LocalDate currentDate = currentDateTime.toLocalDate();
      LocalDateTime startOfDay = currentDate.atStartOfDay();
      LocalDateTime endOfDay = currentDate.atTime(LocalTime.MAX);

      boolean checkVerification = verificationRepository.existsByChallengeIdAndUserAndCreatedAtBetween(
          challengeId, user, startOfDay, endOfDay
      );

      if(checkVerification) {
       throw new GlobalException(ErrorCode.ALREADY_EXISTS_VERIFICATION);
      }

      String imageUrl= amazonS3Client.getResourceUrl(BUCKET, "verification/" + image.getOriginalFilename());
      Verification verification = new Verification(requestDto.getTitle(), requestDto.getContent(), image.getOriginalFilename(), imageUrl, challenge, user);
      verificationRepository.save(verification);
      return new VerificationResponseDto(verification.getId(), verification.getTitle(), verification.getContent(), imageUrl, verification.getStatus());

    } catch(IOException e) {
      throw new FileUploadFailureException("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
    }
  }
```

ì´ì „ì— ì‘ì„±í–ˆë˜ ì½”ë“œë‹¤. ì±Œë¦°ì§€ë¥¼ ìƒì„±í•˜ëŠ” builder ë¶€ë¶„ì€ ë‚´ê°€ ì‘ì„±í•˜ì§„ ì•Šì•˜ê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ë§Œ ë‚´ê°€ ì‘ì„±í–ˆë‹¤. ì¼ë‹¨ ë´ë„ ë¬´ì§€ ê¸¸ë‹¤.. ê°€ë…ì„±ë„ ë–¨ì–´ì§€ê³  ì‹¬ì§€ì–´ ì¸ì¦ìš”ì²­ ë¶€ë¶„ì—ë„ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ ì½”ë“œê°€ ì¤‘ë³µë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ê·¸ë¦¬ê³  ì˜ˆì™¸ì²˜ë¦¬ê°€ ì˜ ë˜ì–´ìˆì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë°,
1) image íŒŒì¼ì´ ë¹„ì–´ìˆëŠ” ê²½ìš°
2) s3 ë²„í‚· ì •ì±…ì— jpg,png,jpeg,gif ì„¤ì •í•´ë†“ì•˜ëŠ”ë°, ë‹¤ë¥¸ íŒŒì¼ í˜•ì‹ì´ ë“¤ì–´ì˜¬ ê²½ìš°
3) íŒŒì¼í¬ê¸°ì— ëŒ€í•œ ì˜ˆì™¸ì²˜ë¦¬

ê·¸ë˜ì„œ ì´ë¶€ë¶„ì— ëŒ€í•œ ì¶”ê°€ ì˜ˆì™¸ì²˜ë¦¬ì™€ ê³µí†µê¸°ëŠ¥ì— ëŒ€í•œ ë¶„ë¦¬ë¡œ ì½”ë“œ ì¤‘ë³µì„ ì œê±°í•˜ê³  ì½”ë“œ ì¬ì‚¬ìš©ì„±ì„ ë†’ì´ê³  ì‹¶ì—ˆë‹¤.

```java
// S3ServiceImpl
public class S3ServiceImpl implements S3Service {

  private final AmazonS3Client amazonS3Client;

  @Value("${cloud.aws.s3.bucket}")
  private String BUCKET;

  @Value("${spring.servlet.multipart.max-file-size}")
  private String maxFileSize;

@Override
  public String imageUpload(MultipartFile image, String key) {
	if (image.isEmpty()) {
	  throw new GlobalException(ErrorCode.EMPTY_FILE);
	}
	fileSizeExceed(image);
	allowedImageTypes(image);
	try {
	  ObjectMetadata metadata = new ObjectMetadata();
	  metadata.setContentType(image.getContentType());
	  metadata.setContentLength(image.getSize());
	  amazonS3Client.putObject(BUCKET, key + image.getOriginalFilename(), image.getInputStream(), metadata);
	  String imageUrl = amazonS3Client.getResourceUrl(BUCKET, key + image.getOriginalFilename());
	  return imageUrl;
	} catch (IOException e) {
	  throw new FileUploadFailureException("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
	}
  }

@Override
  public void deleteChallengeImage(Challenge challenge, String key) {
	DeleteObjectRequest request = new DeleteObjectRequest(BUCKET, key + challenge.getImage());
	amazonS3Client.deleteObject(request);
  }

  @Override
  public void deleteVerificationImage(Verification verification, String key) {
	DeleteObjectRequest request = new DeleteObjectRequest(BUCKET, key + verification.getImageName());
	amazonS3Client.deleteObject(request);
  }

private long parseSize(String size) {
	if (size.endsWith("MB")) {
	  return Long.parseLong(size.replace("MB", "")) * 1024 * 1024;
	} else if (size.endsWith("KB")) {
	  return Long.parseLong(size.replace("KB", "")) * 1024;
	} else if (size.endsWith("GB")) {
	  return Long.parseLong(size.replace("GB", "")) * 1024 * 1024 * 1024;
	} else {
	  return Long.parseLong(size);
	}
  }

  private void fileSizeExceed(MultipartFile image) {
	if (image.getSize() > parseSize(maxFileSize)) {
	  throw new GlobalException(ErrorCode.FILE_UPLOAD_ERROR);
	}
  }

  private void allowedImageTypes(MultipartFile image) {
	String fileName = image.getOriginalFilename();
	if (fileName == null || !fileName.matches(".*\\.(jpg|jpeg|png|gif)$")) {
	  throw new InvalidFileTypeException("ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: " + fileName);
	}
  }
```

ì¼ë‹¨ delete ê°™ì€ê²½ìš°ëŠ” í•´ë‹¹ ê°ì²´ì˜ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì™€ì•¼ í•˜ê¸° ë•Œë¬¸ì— ë§¤ê°œë³€ìˆ˜ì— ëŒ€í•œ ê³ ë¯¼ì„ í–ˆë‹¤.
ë„ˆë¬´ í”¼ê³¤í•œ íƒ“ì¼ê¹Œ.. ì™œ ë„ì €íˆ ì–´ë–»ê²Œ í•´ì•¼í• ì§€ ë– ì˜¤ë¥´ì§€ ì•Šì•˜ë‹¤. ì¼ë‹¨ì€ ë‚˜ì¤‘ì— ë˜ ìˆ˜ì •í•´ë³´ê¸°ë¡œ í•˜ê³  
delete challenge/verification í•¨ìˆ˜ë¥¼ ê°ê° ë§Œë“¤ì–´ì¤¬ë‹¤. (ì¼ë‹¨ ë¬´ì§€ ì°ì°í•˜ë‹¤. ì´ ë¶€ë¶„ì€ ë°©ë²•ì„ ì°¾ì•„ì„œ ì¶”í›„ì— ìˆ˜ì •í•  ê²ƒì´ë‹¤.)

íŒŒì¼ í¬ê¸°ì™€ íŒŒì¼í˜•ì‹ì€ ë‚´ë¶€ë©”ì„œë“œë¡œ ì •ì˜í•´ì£¼ì—ˆë‹¤.

```java
// ë¦¬íŒ©í† ë§ í›„ adminSevice

@Transactional
    public AdminChallengeCreateResponseDto createChallenge(MultipartFile image, AdminChallengeCreateRequestDto reqDto, User loginUser) {
        if (!loginUser.getUserRole().equals(UserRole.ADMIN)) {
            throw new GlobalException(ErrorCode.USER_ACCESS_DENIED);
        }
            String key = "challenge/";
            String imageUrl = s3Service.imageUpload(image, key);
            Challenge challenge = Challenge.builder()
                .title(reqDto.getTitle())
                .content(reqDto.getContent())
                .image(image.getOriginalFilename())
                .imageUrl(imageUrl)
                .category(Category.valueOf(reqDto.getCategory()))
                .conditionStatus(ConditionStatus.valueOf(reqDto.getConditionStatus()))
                .startTime(reqDto.getStartTime())
                .endTime(reqDto.getEndTime())
                .limitedUsers(reqDto.getLimitedUsers())
                .build();
            Challenge savedChallenge = challengeRepository.save(challenge);
            return new AdminChallengeCreateResponseDto(savedChallenge);

    }
```

```java
// ë¦¬íŒ©í† ë§ í›„ VerificationService
@Transactional
  public VerificationResponseDto requestVerification(Long challengeId, MultipartFile image, VerificationRequestDto requestDto, User user) {
      Challenge challenge = challengeService.findById(challengeId);

      duplicateVerification(challengeId, user);

      String key = "verification/";
      String imageUrl = s3Service.imageUpload(image, key);
      Verification verification = new Verification(requestDto.getTitle(), requestDto.getContent(), image.getOriginalFilename(), imageUrl, challenge, user);
      verificationRepository.save(verification);
      return new VerificationResponseDto(verification.getId(), verification.getTitle(), verification.getContent(), imageUrl, verification.getStatus());
  }

  @Transactional
  public void cancelVerification(Long verificationId, User user) {
    Verification verification = findVerificationById(verificationId);
    if(verification.getStatus().equals(Status.APPROVE)) {
      throw new GlobalException(ErrorCode.DO_NOT_CANCEL_VERIFICATION);
    }
    verification.checkUser(user);
    String key = "verification/";
    s3Service.deleteVerificationImage(verification, key);
    verificationRepository.delete(verification);
  }

  private void duplicateVerification(Long challengeId, User user) {
    LocalDateTime currentDateTime = LocalDateTime.now();
    LocalDate currentDate = currentDateTime.toLocalDate();
    LocalDateTime startOfDay = currentDate.atStartOfDay();
    LocalDateTime endOfDay = currentDate.atTime(LocalTime.MAX);

    boolean checkVerification = verificationRepository.existsByChallengeIdAndUserAndCreatedAtBetween(
        challengeId, user, startOfDay, endOfDay
    );

    if(checkVerification) {
      throw new GlobalException(ErrorCode.ALREADY_EXISTS_VERIFICATION);
    }
  }
```

ì´ ë¶€ë¶„ ë§ê³ ë„ ë¦¬íŒ©í† ë§í•´ì•¼ í•  ë‹¤ë¥¸ ì½”ë“œë“¤ì´ ë§ë‹¤..í•˜í•˜í•˜..! 
ì²˜ìŒ ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ì¡°ê¸ˆ ë” ì‹ ì¤‘í•´ì•¼ì§€ í•˜ë©´ì„œë„ ë§ˆê°ê¸°í•œ ë•Œë¬¸ì— ì‹ ê²½ì„ ë§ì´ ëª»ì¼ë˜ ê²ƒ ê°™ë‹¤.
ì´ë²ˆê¸°íšŒë¡œ ë¦¬íŒ©í† ë§ í•˜ë©´ì„œ ë‚˜ì˜ ì½”ë“œê°€ ì°¸ ê°€ë…ì„±ì´ ë§ì´ ë–¨ì–´ì§€êµ¬ë‚˜.. ë¼ëŠ” ìƒê°ì´ ë§ì´ ë“ ë‹¤.

ë” ê³ ë¯¼í•˜ê³  ë” ê³µë¶€í•˜ì..ğŸ¤¦â€â™€ï¸





