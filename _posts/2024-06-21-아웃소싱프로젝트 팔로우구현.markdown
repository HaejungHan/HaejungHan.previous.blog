---
layout: post
title:  "TIL(20240620) [ì•„ì›ƒì†Œì‹±í”„ë¡œì íŠ¸: íŒ”ë¡œìš° êµ¬í˜„]"
date:  2024-06-20
categories: TIL Spring
---

---------------------------------------------------------------------

# ğŸ“Œ Spring

## ğŸ’¡ ì•„ì›ƒì†Œì‹± í”„ë¡œì íŠ¸ : íŒ”ë¡œìš° êµ¬í˜„

ì´ë²ˆ í”„ë¡œì íŠ¸ì˜ ì£¼ì œë¥¼ ìµëª…ê²Œì‹œíŒìœ¼ë¡œ í–ˆê¸° ë•Œë¬¸ì—
ìµëª…ê²Œì‹œíŒ/ë¹„ìµëª…ê²Œì‹œíŒìœ¼ë¡œ êµ¬ë¶„í•˜ì˜€ê³ , ë¹„ìµëª…ê²Œì‹œíŒ ì¡°íšŒì—ì„œ
ìì‹ ì´ íŒ”ë¡œìš°í•œ ì‚¬ëŒë“¤ì˜ ê²Œì‹œë¬¼ì„ ìµœì‹ ìˆœìœ¼ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•´ë³´ì•˜ë‹¤.

- **íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„**
    - íŠ¹ì • ì‚¬ìš©ìë¥¼ íŒ”ë¡œìš° / ì–¸íŒ”ë¡œìš°ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - íŒ”ë¡œìš° ê¸°ëŠ¥ì´ êµ¬í˜„ë˜ì—ˆë‹¤ë©´ ë‰´ìŠ¤í”¼ë“œì— íŒ”ë¡œìš°í•˜ëŠ” ì‚¬ìš©ìì˜ ê²Œì‹œë¬¼ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - íŒ”ë¡œìš°ë¥¼ í•˜ê³  ìˆëŠ” ì‚¬ëŒë“¤ì´ ì‘ì„±í•œ ê²Œì‹œë¬¼ì„ ë³¼ ë•Œ ì •ë ¬ ê¸°ì¤€ì€ ìµœì‹ ìˆœì…ë‹ˆë‹¤.

```java

public List<PublicPostResponseDto> getFollowedPosts(User user, int page, int pageSize) {
    Pageable pageable = PageRequest.of(page, pageSize);

    User currentUser = userService.findByUserSeq(user.getUserSeq());
    List<Follow> follows = followRepository.findByFromUser(currentUser);

    List<PublicPostResponseDto> publicPostResponseDtos = new ArrayList<>();
    for (Follow followerList : follows) {
      User followedUser = followerList.getToUser();
      Page<PublicPost> publicPosts = postRepository.findByUserOrderByCreatedAtDesc(followedUser, pageable);
      if (publicPosts.getTotalElements() == 0) {
        throw new CustomException(ErrorCode.POST_EMPTY);
      }
      for(PublicPost publicPost : publicPosts) {
        PublicPostResponseDto responseDto = new PublicPostResponseDto(publicPost);
        publicPostResponseDtos.add(responseDto);
      }
    }
    return publicPostResponseDtos;
  }

```

ë‚´ê°€ íŒ”ë¡œìš°í•œ ì‚¬ëŒë“¤ì˜ ê²Œì‹œë¬¼ì„ ì¡°íšŒí•˜ëŠ” ë¶€ë¶„ì—ì„œ ë³µì¡í•´ì§€ëŠ” ê²ƒ ê°™ì•„
ì •ë¦¬ê°€ ì•ˆë˜ì–´ì„œ ì¡°ê¸ˆ ê³ ìƒí–ˆë˜ ê²ƒ ê°™ë‹¤ ğŸ¤£

êµ¬í˜„í•œ ì½”ë“œì— ëŒ€í•´ì„œ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…ì„ í•´ë³´ìë©´ userServiceì—ì„œ userì˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³  currentUserê°€ íŒ”ë¡œìš°í•œ ëª¨ë“  ì‚¬ìš©ìë¥¼ ê°€ì ¸ì˜¨ ë‹¤ìŒ ê·¸ ëª¨ë“  ì‚¬ìš©ìì˜ publicPostë¥¼ ê°€ì ¸ì˜¤ê³  ìµœì‹ ìˆœìœ¼ë¡œ í˜ì´ì§€ ì²˜ë¦¬ë¥¼ í•œë‹¤. publicPostsê°€ 0 ì´ë¼ë©´ ì˜ˆì™¸ë¥¼ ë‚ ë¦¬ê³  ì•„ë‹ˆë¼ë©´ reponseDtoì— ê°ì²´ì— publicPostë¥¼ ë‹´ì•„ì„œ ë°˜í™˜í•œë‹¤.


```java

@RestController
@RequiredArgsConstructor
@RequestMapping("/api")
public class FollowController {

  private final UserService userService;
  private final FollowService followService;

  // íŒ”ë¡œìš°
  @PostMapping("/follower")
  public ResponseEntity<String> followUser(@RequestBody @Valid FollowRequestDto requestDto, @AuthenticationPrincipal UserDetailsImpl userDetails) {
    User toUser = userService.findByUserSeq(requestDto.getToUserSeq());
    User fromUser = userService.findByUserSeq(userDetails.getUser().getUserSeq());
    followService.followUser(toUser, fromUser);
    return ResponseEntity.status(HttpStatus.OK).body(toUser.getUserId() + " ë‹˜ì„ íŒ”ë¡œìš° í•˜ì˜€ìŠµë‹ˆë‹¤.");
  }

  // ì–¸íŒ”ë¡œìš°
  @DeleteMapping("/follower")
 public ResponseEntity<String> deleteFollowUser(@RequestBody @Valid FollowRequestDto requestDto, @AuthenticationPrincipal UserDetailsImpl userDetails) {
    User toUser = userService.findByUserSeq(requestDto.getToUserSeq());
    User fromUser = userService.findByUserSeq(userDetails.getUser().getUserSeq());
    followService.deleteFollowUser(toUser, fromUser);
    return ResponseEntity.status(HttpStatus.OK).body(toUser.getUserId() + " ë‹˜ì„ íŒ”ë¡œìš°ì·¨ì†Œ í•˜ì˜€ìŠµë‹ˆë‹¤.");
  }

  // ë‚´ê°€ íŒ”ë¡œìš°í•œ ì‚¬ëŒë“¤ ì¡°íšŒ
  @GetMapping("/followers")
  public ResponseEntity<List<FollowResponseDto>> getFollowings(@AuthenticationPrincipal UserDetailsImpl userDetails) {
    User user = userService.findByUserSeq(userDetails.getUser().getUserSeq());
    List<FollowResponseDto> followers = followService.getFollowings(user);
    return ResponseEntity.status(HttpStatus.OK).body(followers);
  }
}

```
ì½”ë“œ í’€ì´ í•„ìš”

```java

@Service
@RequiredArgsConstructor
public class FollowService {

  private final FollowRepository followRepository;

  @Transactional
  public void followUser(User toUser, User fromUser) {
    if(fromUser.getUserSeq().equals(toUser.getUserSeq())) {
      throw new CustomException(ErrorCode.SAME_USER);
    }
    Optional<Follow> checkFollow = followRepository.findByFromUserAndToUser(fromUser, toUser);
    if(checkFollow.isPresent()) {
      throw new CustomException(ErrorCode.ALREADY_FOLLOW);
    }
    Follow follow = new Follow(fromUser, toUser);
    followRepository.save(follow);
  }

  @Transactional
  public void deleteFollowUser(User toUser, User fromUser) {
    Optional<Follow> checkFollow = followRepository.findByFromUserAndToUser(fromUser, toUser);
    if(checkFollow.isEmpty()) {
      throw new CustomException(ErrorCode.RECENT_NOT_FOLLOW);
    }
    followRepository.delete(checkFollow.get());
  }

  @Transactional(readOnly = true)
  public List<FollowResponseDto> getFollowings(User user) {
    List<FollowResponseDto> followResponseDtoList = new ArrayList<>();
    for(Follow follow : user.getFollowings()) {
      followResponseDtoList.add(new FollowResponseDto(follow.getToUser()));
    }
    return followResponseDtoList;
  }
}

```

ì½”ë“œ í’€ì´ í•„ìš”

```java

@Getter
@Entity
@NoArgsConstructor
public class Follow extends Timestamped {
  @Id
  @GeneratedValue(strategy = GenerationType.IDENTITY)
  @Column(name = "follow_id")
  private Long id;

  @ManyToOne
  @JoinColumn(name = "from_user")
  private User fromUser;

  @ManyToOne
  @JoinColumn(name = "to_user")
  private User toUser;

  public Follow(User fromUser, User toUser){
    this.fromUser = fromUser;
    this.toUser =toUser;
  }
}


```

ì½”ë“œ í’€ì´ í•„ìš”